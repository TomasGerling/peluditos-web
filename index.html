<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="Peluditos Petshop en Necochea. Cat√°logo actualizado.">
    <meta name="theme-color" content="#FF8C42">
    <title>Peluditos Petshop - Cat√°logo Online</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R43T32J1Z1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-R43T32J1Z1');
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #FF8C42; --primary-dark: #e67e3b;
            --secondary: #4CA1A3; --accent: #FFD93D;
            --text: #2c2c2c; --text-light: #595959;
            --bg: #f4f6f8; --white: #ffffff;
            --input-bg: #fafafa; --border: #e0e0e0;
            --whatsapp: #25D366; --offer: #D32F2F;
            --btn-bg: #f0f0f0; --card-radius: 16px;
            --shadow: 0 4px 12px rgba(0,0,0,0.04);
            --shadow-header: 0 2px 15px rgba(0,0,0,0.05);
        }

        [data-theme="dark"] {
            --primary: #FF8C42; --primary-dark: #ff9e5e;
            --secondary: #4CA1A3;
            --text: #e0e0e0; --text-light: #aaaaaa;
            --bg: #121212; --white: #1e1e1e;
            --input-bg: #2d2d2d; --border: #333333;
            --btn-bg: #2d2d2d; --offer: #ff5252;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-header: 0 2px 15px rgba(0,0,0,0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Open Sans', sans-serif; margin: 0; padding: 0; background-color: var(--bg); color: var(--text); padding-bottom: 100px; transition: background-color 0.3s, color 0.3s; }

        /* HEADER & NAV */
        header { background-color: var(--white); padding: 0.8rem 5%; box-shadow: var(--shadow-header); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .logo { font-family: 'Fredoka', sans-serif; font-size: 1.5rem; font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 8px; text-decoration: none; }
        .logo i { color: var(--secondary); transform: rotate(-10deg); }
        .header-actions { display: flex; align-items: center; gap: 10px; }
        
        .user-btn { font-size: 0.9rem; color: var(--primary); background: rgba(255, 140, 66, 0.1); padding: 8px 15px; border-radius: 50px; border: 1px solid transparent; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .user-btn:hover { background: var(--primary); color: #fff; }
        .theme-toggle { background: var(--btn-bg); border: none; color: var(--text); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; }

        /* HERO & SEARCH */
        .hero { background: linear-gradient(135deg, var(--secondary), #2c7a7b); color: #ffffff; text-align: center; padding: 2.5rem 1rem 3.5rem 1rem; border-radius: 0 0 30px 30px; margin-bottom: -30px; }
        .hero h1 { font-family: 'Fredoka', sans-serif; margin: 0 0 8px 0; font-size: 2.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .promo-pill { background: rgba(0,0,0,0.25); display: inline-block; padding: 6px 16px; border-radius: 20px; margin-top: 15px; font-size: 0.95rem; border: 1px solid rgba(255,255,255,0.4); font-weight: 600; backdrop-filter: blur(5px); }

        .controls-wrapper { max-width: 1200px; margin: 0 auto 25px auto; padding: 0 20px; position: relative; z-index: 10; }
        .search-container { background: var(--white); padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.06); display: flex; flex-direction: column; gap: 15px; }
        .search-row { display: flex; gap: 10px; width: 100%; }
        .search-box { position: relative; flex-grow: 1; }
        .search-box input { width: 100%; padding: 14px 20px 14px 45px; border-radius: 12px; border: 2px solid var(--border); font-size: 1rem; outline: none; background: var(--input-bg); color: var(--text); font-family: 'Open Sans', sans-serif; }
        .search-box i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        .sort-select { padding: 0 15px; border-radius: 12px; border: 2px solid var(--border); background: var(--input-bg); color: var(--text); font-family: 'Open Sans', sans-serif; cursor: pointer; min-width: 130px; font-weight: 600; }
        
        .filter-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-scroll::-webkit-scrollbar { display: none; }
        .filter-btn { background: var(--white); border: 1px solid var(--border); color: var(--text-light); padding: 8px 18px; border-radius: 50px; font-family: 'Fredoka', sans-serif; font-weight: 600; white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 6px; flex-shrink: 0; font-size: 0.95rem; }
        .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 3px 10px rgba(255, 140, 66, 0.25); }

        /* PRODUCT GRID */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; padding: 0 20px; content-visibility: auto; }
        .card { background: var(--white); border-radius: var(--card-radius); overflow: hidden; box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; flex-direction: column; justify-content: space-between; }
        .card-img-container { width: 100%; height: 180px; background: var(--white); display: flex; align-items: center; justify-content: center; position: relative; padding: 15px; border-bottom: 1px solid var(--border); }
        .product-img { width: auto; height: 100%; max-width: 75%; max-height: 160px; object-fit: contain; }
        .category-label { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 0.9rem; color: var(--text-light); writing-mode: vertical-rl; pointer-events: none; }
        .offer-badge { position: absolute; top: 10px; left: 10px; background: var(--offer); color: white; font-size: 0.75rem; font-weight: 700; padding: 4px 8px; border-radius: 6px; }
        
        .card-header { padding: 1rem 1.2rem 0.5rem 1.2rem; }
        .card-title { font-family: 'Fredoka', sans-serif; font-size: 1.1rem; color: var(--text); margin: 0; line-height: 1.35; text-transform: capitalize; font-weight: 600; min-height: 3rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-body { padding: 0.5rem 1.2rem 1.2rem 1.2rem; }
        .price-option { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 8px 10px; background: var(--input-bg); border-radius: 10px; border: 1px solid var(--border); }
        .price-info { display: flex; flex-direction: column; }
        .price-label { font-size: 0.75rem; color: var(--text-light); font-weight: 700; text-transform: uppercase; }
        .price-amount { font-weight: 800; font-size: 1rem; color: var(--text); }
        .btn-add { background: var(--white); border: 1px solid var(--border); width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--primary); transition: all 0.2s; }
        .btn-add:hover { background: var(--primary); color: #fff; border-color: var(--primary); }

        /* FLOATING UI */
        .cart-float { position: fixed; bottom: 30px; right: 25px; background: var(--text); color: var(--bg); width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.4rem; box-shadow: 0 8px 20px rgba(0,0,0,0.25); cursor: pointer; z-index: 1000; border: none; }
        .cart-badge { position: absolute; top: -2px; right: -2px; background-color: var(--offer); border: 2px solid var(--white); color: #fff; border-radius: 50%; width: 22px; height: 22px; font-size: 0.75rem; display: flex; justify-content: center; align-items: center; font-weight: 700; }
        .support-float { position: fixed; bottom: 30px; left: 25px; background-color: var(--white); color: var(--whatsapp); width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.6rem; box-shadow: 0 4px 15px rgba(0,0,0,0.15); cursor: pointer; z-index: 1000; text-decoration: none; border: 1px solid var(--border); }

        /* MODALS (Shared Styles) */
        .cart-modal { position: fixed; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100vh; background: var(--white); z-index: 1001; transition: right 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; flex-direction: column; box-shadow: -5px 0 30px rgba(0,0,0,0.2); }
        .cart-modal.active { right: 0; }
        .cart-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; backdrop-filter: blur(2px); }
        .cart-overlay.active { display: block; }
        .cart-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--white); }
        .cart-items { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .cart-footer { padding: 20px; border-top: 1px solid var(--border); background: var(--white); }
        
        .btn-whatsapp { background-color: var(--whatsapp); color: #fff; border: none; width: 100%; padding: 16px; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; text-transform: uppercase; transition: background 0.3s; }
        .btn-whatsapp:hover { background-color: #1ebc57; }
        
        /* CART SPECIFIC */
        .cart-item { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .qty-control { display: flex; align-items: center; gap: 12px; background: var(--input-bg); padding: 4px 12px; border-radius: 20px; border: 1px solid var(--border); }
        .qty-btn { border: none; background: none; font-weight: bold; cursor: pointer; color: var(--primary); font-size: 1.2rem; padding: 0; }

        /* CHECKOUT FORMS */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; color: var(--text); }
        .form-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text); font-family: inherit; font-size: 1rem; }
        .row { display: flex; gap: 15px; }
        .radio-group { display: flex; gap: 10px; }
        .radio-card { flex: 1; position: relative; }
        .radio-card input { position: absolute; opacity: 0; cursor: pointer; }
        .radio-card-content { border: 1px solid var(--border); border-radius: 10px; padding: 15px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: all 0.2s; background: var(--input-bg); height: 100%; }
        .radio-card input:checked + .radio-card-content { border-color: var(--primary); background: rgba(255, 140, 66, 0.1); }
        .radio-circle { width: 18px; height: 18px; border: 2px solid var(--text-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .radio-card input:checked + .radio-card-content .radio-circle { border-color: var(--primary); background: var(--primary); box-shadow: inset 0 0 0 3px var(--white); }
        .hidden { display: none; }

        /* LOGIN MODAL & HISTORY */
        .login-content { text-align: center; padding: 30px 20px; }
        .login-btn-primary { background: #e65100; color: white; width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; margin-top: 15px; }
        .login-btn-primary:hover { background: #d84315; }
        .phone-input-group { display: flex; gap: 0; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-top: 10px; }
        .prefix-box { background: var(--input-bg); padding: 12px; border-right: 1px solid var(--border); color: var(--text-light); font-weight: 600; display:flex; align-items:center; }
        .phone-field { border: none; padding: 12px; width: 100%; outline: none; background: var(--white); color: var(--text); font-size: 1rem; }
        
        /* History Card */
        .history-card { background: var(--input-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; color: var(--text-light); }
        .history-items { font-size: 0.9rem; margin-bottom: 12px; color: var(--text); }
        .history-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); padding-top: 10px; }
        .btn-repeat { background: var(--whatsapp); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
        .history-price { font-weight: 800; font-size: 1.1rem; color: var(--primary); }

        .skeleton { background: linear-gradient(90deg, var(--input-bg) 25%, var(--border) 50%, var(--input-bg) 75%); background-size: 200% 100%; animation: shine 1.5s infinite; border-radius: 16px; height: 300px; }
        @keyframes shine { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        @media (max-width: 600px) {
            .grid-container { grid-template-columns: 1fr; gap: 15px; }
            .card { flex-direction: row; align-items: center; min-height: 140px; }
            .card-img-container { width: 120px; height: 100%; padding: 10px; border-bottom: none; border-right: 1px solid var(--border); justify-content: center; }
            .product-img { max-width: 100%; max-height: 110px; }
            .category-label { display: none; } 
            .card-header { padding: 15px 10px 5px 10px; }
            .card-body { padding: 5px 10px 15px 10px; width: 100%; }
        }
    </style>
</head>
<body>

<header>
    <a href="#" class="logo" onclick="location.reload()" aria-label="Recargar p√°gina">
        <i class="fa-solid fa-paw"></i> Peluditos
    </a>
    
    <div class="header-actions">
        <button id="user-btn-display" class="user-btn" onclick="openLoginOrProfile()">
            <i class="fa-regular fa-user"></i> <span>Ingresar</span>
        </button>

        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Cambiar modo oscuro" id="themeBtn">
            <i class="fa-solid fa-moon"></i>
        </button>
    </div>
</header>

<main>
    <section class="hero">
        <h1>Lo mejor para tu mascota</h1>
        <p>Alimento balanceado y accesorios en Necochea</p>
        <div class="promo-pill">
            <i class="fa-solid fa-gift"></i> Promo: 10kg acumulables = 1kg de regalo
        </div>
    </section>

    <div class="controls-wrapper">
        <div class="search-container">
            <div class="search-row">
                <div class="search-box">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="searchInput" placeholder="Buscar marca, piedras..." onkeyup="applyFilters()">
                </div>
                <select id="priceSort" class="sort-select" onchange="applyFilters()">
                    <option value="default">Relevancia</option>
                    <option value="asc">Menor Precio</option>
                    <option value="desc">Mayor Precio</option>
                </select>
            </div>
            <nav class="filter-scroll">
                <button class="filter-btn active" onclick="setCategory('all', this)">Todos</button>
                <button class="filter-btn" onclick="setCategory('perro', this)"><i class="fa-solid fa-dog"></i> Perros</button>
                <button class="filter-btn" onclick="setCategory('gato', this)"><i class="fa-solid fa-cat"></i> Gatos</button>
                <button class="filter-btn" onclick="setCategory('otros', this)">Otros</button>
            </nav>
        </div>
    </div>

    <div id="loader" class="grid-container">
        <div class="skeleton"></div><div class="skeleton"></div>
    </div>

    <div class="grid-container" id="product-grid" style="display:none;"></div>
</main>

<a href="#" id="supportBtn" class="support-float"><i class="fa-brands fa-whatsapp"></i></a>
<button class="cart-float" onclick="toggleCart()">
    <i class="fa-solid fa-basket-shopping"></i>
    <div class="cart-badge" id="cart-count">0</div>
</button>

<div class="cart-overlay" id="cart-overlay" onclick="closeAllModals()"></div>

<div class="cart-modal" id="cart-modal">
    <div class="cart-header">
        <h3 id="cart-title" style="margin:0">Mi Pedido</h3>
        <button onclick="closeAllModals()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">√ó</button>
    </div>
    <div class="cart-items" id="cart-items"></div>
    <div class="cart-footer">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:800; font-size:1.1rem;">
            <span>Total:</span><span id="cart-total">$0</span>
        </div>
        <button class="btn-whatsapp" onclick="checkout()">Iniciar Pedido</button>
    </div>
</div>

<div class="cart-modal" id="checkout-modal" style="z-index: 1002;">
    <div class="cart-header">
        <h3 style="margin:0"><i class="fa-solid fa-clipboard-check"></i> Finalizar Pedido</h3>
        <button onclick="closeCheckout()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">√ó</button>
    </div>
    <div class="cart-items" style="padding: 20px;">
        <div class="form-group">
            <label class="form-label"><i class="fa-regular fa-user"></i> Informaci√≥n del Cliente</label>
            <div class="row">
                <input type="text" id="cx-name" class="form-input" placeholder="Tu Nombre *" required>
                <input type="tel" id="cx-phone" class="form-input" placeholder="Tel√©fono *" required>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label"><i class="fa-solid fa-truck-fast"></i> Tipo de Entrega</label>
            <div class="radio-group">
                <label class="radio-card">
                    <input type="radio" name="deliveryType" value="retiro" checked onchange="toggleAddress(false)">
                    <div class="radio-card-content">
                        <div class="radio-circle"></div>
                        <div>
                            <div style="font-weight:700">Retiro en Local</div>
                            <div style="font-size:0.8rem; color:var(--text-light)">Sin costo</div>
                        </div>
                    </div>
                </label>
                <label class="radio-card">
                    <input type="radio" name="deliveryType" id="opt-delivery" value="delivery" onchange="toggleAddress(true)">
                    <div class="radio-card-content">
                        <div class="radio-circle"></div>
                        <div>
                            <div style="font-weight:700">Delivery</div>
                            <div style="font-size:0.8rem; color:var(--text-light)" id="delivery-text">Env√≠o a domicilio</div>
                        </div>
                    </div>
                </label>
            </div>
        </div>
        <div id="address-section" class="hidden">
            <div class="form-group">
                <label class="form-label">Direcci√≥n de Entrega</label>
                <input type="text" id="cx-calle" class="form-input" placeholder="Calle y Altura *" style="margin-bottom:10px">
                <div class="row">
                    <input type="text" id="cx-piso" class="form-input" placeholder="Piso/Depto">
                    <input type="text" id="cx-entre" class="form-input" placeholder="Entre calles">
                </div>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label"><i class="fa-regular fa-credit-card"></i> Forma de Pago</label>
            <div class="radio-group">
                <label class="radio-card">
                    <input type="radio" name="paymentType" value="efectivo" checked>
                    <div class="radio-card-content">
                        <div class="radio-circle"></div>
                        <div>
                            <div style="font-weight:700">Efectivo</div>
                            <div style="font-size:0.8rem; color:var(--text-light)">Al recibir</div>
                        </div>
                    </div>
                </label>
                <label class="radio-card">
                    <input type="radio" name="paymentType" value="transferencia">
                    <div class="radio-card-content">
                        <div class="radio-circle"></div>
                        <div>
                            <div style="font-weight:700">Transf.</div>
                            <div style="font-size:0.8rem; color:var(--text-light)">Anticipado</div>
                        </div>
                    </div>
                </label>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label"><i class="fa-regular fa-comment"></i> Observaciones</label>
            <textarea id="cx-obs" class="form-input" rows="2" placeholder="Ej: Timbre no funciona..."></textarea>
        </div>
    </div>
    <div class="cart-footer">
        <button class="btn-whatsapp" onclick="sendOrder()">
            <i class="fa-brands fa-whatsapp"></i> Confirmar y Enviar
        </button>
    </div>
</div>

<div class="cart-modal" id="login-modal" style="z-index: 1003; height: auto; min-height: 50vh; bottom:0; top:auto; border-radius: 20px 20px 0 0;">
    <div class="cart-header">
        <h3 style="margin:0">Iniciar Sesi√≥n</h3>
        <button onclick="closeAllModals()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">√ó</button>
    </div>
    <div class="cart-items login-content">
        <p style="color:var(--text-light); margin-bottom:20px;">Ingresa tu n√∫mero de tel√©fono para acceder a tu historial y repetir pedidos.</p>
        
        <div id="step-phone">
            <label class="form-label" style="text-align:left">N√∫mero de tel√©fono</label>
            <div class="phone-input-group">
                <div class="prefix-box">AR +54</div>
                <input type="tel" id="login-phone" class="phone-field" placeholder="Ej: 2262123456" onkeyup="checkEnter(event, 'checkPhone')">
            </div>
            <button class="login-btn-primary" onclick="handleLoginCheck()">Continuar</button>
        </div>

        <div id="step-name" class="hidden">
            <p style="color:var(--primary); font-weight:600;">¬°Es tu primera vez aqu√≠!</p>
            <label class="form-label" style="text-align:left">¬øC√≥mo te llamas?</label>
            <input type="text" id="login-name" class="form-input" placeholder="Tu Nombre" style="margin-top:5px;" onkeyup="checkEnter(event, 'register')">
            <button class="login-btn-primary" onclick="handleRegister()">Crear Cuenta</button>
        </div>
    </div>
</div>

<div class="cart-modal" id="profile-modal" style="z-index: 1003;">
    <div class="cart-header">
        <h3 style="margin:0">Mi Perfil</h3>
        <button onclick="closeAllModals()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">√ó</button>
    </div>
    <div class="cart-items">
        <div style="background:var(--input-bg); padding:15px; border-radius:12px; display:flex; align-items:center; gap:15px; margin-bottom:20px;">
            <div style="width:50px; height:50px; background:var(--primary); color:white; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:1.5rem; font-weight:bold;" id="profile-initial">U</div>
            <div>
                <h3 id="profile-name" style="margin:0;">Usuario</h3>
                <span id="profile-phone" style="color:var(--text-light); font-size:0.9rem;">...</span>
            </div>
            <button onclick="logout()" style="margin-left:auto; border:none; background:none; color:var(--offer); cursor:pointer;"><i class="fa-solid fa-right-from-bracket"></i></button>
        </div>

        <h4 style="margin-bottom:15px;">Historial de Pedidos</h4>
        <div id="history-container">
            </div>
    </div>
</div>

<footer>
    <p><strong>Peluditos Petshop</strong><br>Necochea, Buenos Aires</p>
</footer>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRbHFTGg7yD-wla-WTyuksMKmoPhblVtdrNAEf_BpQStuoAvVQZx2cwgigSYETo_A/pub?gid=1152455124&single=true&output=csv";
    const WHATSAPP_NUMBER = "5492262677026"; 
    const ENABLE_DELIVERY = false; 

    // DATA VARIABLES
    let allProducts = [];
    let cart = [];
    let currentCategory = 'all';
    
    // USUARIO LOCAL (Login System)
    let currentUser = null; 
    let userHistory = []; 

    // IMAGENES
    const customImages = {
        "agility adulto raza pequena": "./img/agility-adulto-raza-pequena.webp",
        "agility cachorro": "./img/agility-cachorro.webp",
        "agility adulto": "./img/agility-adulto.webp",
        "advance bio adulto r. pequena": "./img/advance-bio-adulto-r-pequena.webp",
        "advance bio adulto": "./img/advance-bio-adulto.webp",
        "advance bio cachorro": "./img/advance-bio-cachorro.webp",
        "advance bio cordero": "./img/advance-bio-cordero.webp",
        "dog chow adultos razas pequenas": "https://www.purina.com.ar/sites/default/files/styles/webp/public/2022-10/Dog-Chow-Adultos-Minis-y-Peque%C3%B1os.jpg.webp",
        "dog chow adultos razas medianas": "./img/dog-chow-adultos-razas-medianas.webp",
        "dogui cachorros": "./img/dogui-cachorros.webp",
        "dogui carne": "./img/dogui-carne.webp",
        "energy food adultos": "./img/energy-food-adultos.webp",
        "energy food cachorros": "./img/energy-food-cachorros.webp",
        "pipon pipon": "./img/pipon-pipon.webp",
        "eukanuba adulto": "./img/eukanuba-adulto.webp",
        "eukanuba adulto pequeno": "./img/eukanuba-adulto-pequeno.webp",
        "eukanuba cachorro": "./img/eukanuba-cachorro.webp",
        "excellent perro adulto m. pequena": "./img/excellent-perro-adulto-m-pequena.webp",
        "excellent perro cachorro m. pequena": "./img/excellent-perro-cachorro-m-pequena.webp",
        "fandog criadores": "./img/fandog-criadores.webp",
        "guardian adulto": "./img/guardian-adulto.webp",
        "guardian cachorro": "./img/guardian-cachorro.webp",
        "nutricare ad. mordida grande": "./img/nutricare-ad-mordida-grande.webp",
        "nutricare ad. mordida pequena": "./img/nutricare-ad-mordida-pequena.webp",
        "old prince hipoalergenico": "./img/old-prince-hipoalergenico.webp",
        "pedigree adultos carne": "./img/pedigree-adultos-carne.webp",
        "pedigree adultos carne y vegetales": "./img/pedigree-adultos-carne-y-vegetales.webp",
        "pedigree adultos razas pequenas": "./img/pedigree-adultos-razas-pequenas.webp",
        "pedigree cachorros": "./img/pedigree-cachorros.webp",
        "pedigree senior +7": "./img/pedigree-senior-7.webp",
        "royal canin mini junior mini": "./img/royal-canin-mini-junior-mini.webp",
        "royal canin mini adulto mini": "./img/royal-canin-mini-adulto-mini.webp",
        "royal canin performance adulto": "./img/royal-canin-performance-adulto.webp",
        "royal canin performance junior": "./img/royal-canin-performance-junior.webp",
        "sabrositos mix perro": "./img/sabrositos-mix-perro.webp",
        "sileoni": "./img/sileoni.webp",
        "vital can premium adulto": "./img/vital-can-premium-adulto.webp",
        "sieger": "./img/sieger.webp",
        "gooster": "./img/gooster.webp",
        "7 vidas": "./img/7-vidas.webp",
        "advance bio gato adulto": "./img/advance-bio-gato-adulto.webp",
        "advance bio gato urinary": "./img/advance-bio-gato-urinary.webp",
        "agility gato adulto": "./img/agility-gato-adulto.webp",
        "agility gato kitten": "./img/agility-gato-kitten.webp",
        "agility gato urinary": "./img/agility-gato-urinary.webp",
        "cat chow adulto carne": "./img/cat-chow-adulto-carne.webp",
        "cat chow adulto pescado": "./img/cat-chow-adulto-pescado.webp",
        "cat chow esterilizados": "./img/cat-chow-esterilizados.webp",
        "cat chow gatitos": "./img/cat-chow-gatitos.webp",
        "energy food gato": "./img/energy-food-gato.webp",
        "excellent adult cat": "./img/excellent-adult-cat.webp",
        "excelent kitten": "./img/excelent-kitten.webp",
        "excellent urinary adult cat": "./img/excellent-urinary-adult-cat.webp",
        "gati carne y pollo": "./img/gati-carne-y-pollo.webp",
        "gati pescado y salmon": "./img/gati-pescado-y-salmon.webp",
        "guardian gato adulto": "./img/guardian-gato-adulto.webp",
        "royal canin fit 32": "./img/royal-canin-fit-32.webp",
        "royal canin performance adult gato": "./img/royal-canin-performance-adult-gato.webp",
        "royal canin performance gato kitten": "./img/royal-canin-performance-gato-kitten.webp",
        "royal canin urinary": "./img/royal-canin-urinary.webp",
        "sabrositos mix gato": "./img/sabrositos-mix-gato.webp",
        "vital can complete kitten": "./img/vital-can-complete-kitten.webp",
        "vital can complete gato adulto": "./img/vital-can-complete-gato-adulto.webp",
        "whiskas carne": "./img/whiskas-carne.webp",
        "whiskas pescado": "./img/whiskas-pescado.webp",
        "whiskas pollo": "./img/whiskas-pollo.webp",
        "arroz saborizado": "./img/arroz-saborizado.webp",
    };
    const brandImages = {
        "royal": "https://upload.wikimedia.org/wikipedia/commons/thumb/8/83/Royal_Canin_logo.svg/300px-Royal_Canin_logo.svg.png",
        "pedigree": "https://1000marcas.net/wp-content/uploads/2021/06/Pedigree-Logo.png",
        "whiskas": "https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Whiskas_Logo.svg/300px-Whiskas_Logo.svg.png",
        "gati": "https://d22fxaf9t8d39k.cloudfront.net/60df9370accc82d7c0e78263724c9b207e865f6003759902cf6993c107567c9c90287.png",
        "dogui": "https://seeklogo.com/images/D/dogui-logo-227B23B75C-seeklogo.com.png",
        "raza": "https://www.grupo-molino.com/wp-content/uploads/2020/09/raza-logo.png",
        "eukanuba": "https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/Eukanuba_logo.svg/300px-Eukanuba_logo.svg.png",
        "pro plan": "https://1000marcas.net/wp-content/uploads/2021/06/Purina-Pro-Plan-logo.png",
        "excellent": "https://www.purina-latam.com/sites/g/files/auxxlc391/files/styles/kraken_generic_max_width_500/public/2021-02/Purina%20Excellent%20Logo.png",
        "old prince": "https://oldprince.com.ar/assets/images/logo_op.png",
        "sieger": "https://sieger.com.ar/wp-content/uploads/2019/08/logo-sieger.png",
        "pipon": "https://static.wixstatic.com/media/893c12_3c003250005747449520443423759727~mv2.png",
        "advance": "https://advancebio.com.ar/wp-content/uploads/2024/09/logo-advance-bio-1.svg",
        "agility": "https://agility.com.ar/wp-content/uploads/2020/09/Logo-Agility.png",
        "dog chow": "https://www.purina.com.ar/sites/default/files/styles/webp/public/2021-02/Dog%20Chow%20Logo.png.webp"
    };

    document.getElementById('supportBtn').href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent("Hola Peluditos! Tengo una consulta...")}`;
    
    // INICIALIZACION
    window.onload = function() { 
        initTheme();
        loadUserSession(); 
        loadCart(); 
        fetchData(); 
    };

    // --- SISTEMA DE USUARIOS Y LOGIN (Local Storage) ---

    function loadUserSession() {
        const storedUser = localStorage.getItem('peluditos_user');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            updateUserUI(true);
            const storedHistory = localStorage.getItem('peluditos_history_' + currentUser.phone);
            userHistory = storedHistory ? JSON.parse(storedHistory) : [];
        } else {
            updateUserUI(false);
        }
    }

    function updateUserUI(isLoggedIn) {
        const btn = document.getElementById('user-btn-display');
        if (isLoggedIn) {
            btn.innerHTML = `<i class="fa-solid fa-user"></i> <span>${currentUser.name.split(' ')[0]}</span>`;
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-phone').innerText = "+54 " + currentUser.phone;
            document.getElementById('profile-initial').innerText = currentUser.name.charAt(0).toUpperCase();
        } else {
            btn.innerHTML = `<i class="fa-regular fa-user"></i> <span>Ingresar</span>`;
        }
    }

    function openLoginOrProfile() {
        closeAllModals();
        if (currentUser) {
            renderHistory();
            document.getElementById('profile-modal').classList.add('active');
            document.getElementById('cart-overlay').classList.add('active');
        } else {
            document.getElementById('step-phone').classList.remove('hidden');
            document.getElementById('step-name').classList.add('hidden');
            document.getElementById('login-phone').value = '';
            document.getElementById('login-modal').classList.add('active');
            document.getElementById('cart-overlay').classList.add('active');
            setTimeout(() => document.getElementById('login-phone').focus(), 300);
        }
    }

    function handleLoginCheck() {
        const phoneInput = document.getElementById('login-phone').value.trim();
        if (phoneInput.length < 8) {
            Swal.fire({ text: 'Ingresa un n√∫mero v√°lido (sin 0 ni 15)', icon: 'warning', toast:true, position:'top', timer:2000, showConfirmButton:false });
            return;
        }

        let usersDB = JSON.parse(localStorage.getItem('peluditos_users_db')) || {};
        
        if (usersDB[phoneInput]) {
            currentUser = usersDB[phoneInput];
            localStorage.setItem('peluditos_user', JSON.stringify(currentUser));
            finishLogin();
        } else {
            document.getElementById('step-phone').classList.add('hidden');
            document.getElementById('step-name').classList.remove('hidden');
            setTimeout(() => document.getElementById('login-name').focus(), 300);
        }
    }

    function handleRegister() {
        const phone = document.getElementById('login-phone').value.trim();
        const name = document.getElementById('login-name').value.trim();
        
        if (name.length < 2) {
            Swal.fire({ text: 'Escribe tu nombre', icon: 'warning', toast:true, position:'top' });
            return;
        }

        const newUser = { phone, name, joined: new Date().toISOString() };
        let usersDB = JSON.parse(localStorage.getItem('peluditos_users_db')) || {};
        usersDB[phone] = newUser;
        localStorage.setItem('peluditos_users_db', JSON.stringify(usersDB));
        currentUser = newUser;
        localStorage.setItem('peluditos_user', JSON.stringify(currentUser));
        finishLogin();
    }

    function finishLogin() {
        loadUserSession();
        closeAllModals();
        Swal.fire({ icon: 'success', title: `¬°Hola ${currentUser.name}!`, toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
    }

    function logout() {
        localStorage.removeItem('peluditos_user');
        currentUser = null;
        userHistory = [];
        updateUserUI(false);
        closeAllModals();
        Swal.fire({ text: 'Sesi√≥n cerrada', icon: 'info', toast:true, position:'top-end', timer:1500, showConfirmButton:false });
    }
    
    function checkEnter(e, action) {
        if (e.key === "Enter") {
            if (action === 'checkPhone') handleLoginCheck();
            if (action === 'register') handleRegister();
        }
    }

    function renderHistory() {
        const container = document.getElementById('history-container');
        if (!userHistory || userHistory.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:var(--text-light); padding:20px;">A√∫n no tienes pedidos guardados.</p>';
            return;
        }

        let html = '';
        [...userHistory].reverse().forEach((order, idx) => {
            const date = new Date(order.date).toLocaleDateString('es-AR');
            const itemsSummary = order.items.map(i => `${i.qty}x ${i.name}`).join(', ');
            const realIdx = userHistory.length - 1 - idx;
            
            html += `
            <div class="history-card">
                <div class="history-header">
                    <span>Pedido #${1000 + realIdx}</span>
                    <span>${date}</span>
                </div>
                <div class="history-items">${itemsSummary}</div>
                <div class="history-footer">
                    <span class="history-price">$${order.total.toLocaleString('es-AR')}</span>
                    <button class="btn-repeat" onclick="repeatOrder(${realIdx})">
                        <i class="fa-solid fa-rotate-right"></i> Repetir
                    </button>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function repeatOrder(idx) {
        const order = userHistory[idx];
        if (!order) return;
        
        order.items.forEach(item => {
            const existing = cart.find(c => c.name === item.name && c.type === item.type);
            if (existing) { existing.qty += item.qty; } else { cart.push({ ...item }); }
        });
        
        saveCart();
        updateCartUI();
        closeAllModals();
        toggleCart(); 
        Swal.fire({ title: 'Productos agregados', icon: 'success', toast: true, position: 'bottom-end', timer: 1500, showConfirmButton: false });
    }

    // --- CORE FUNCTIONS ---

    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            updateThemeIcon('dark');
        }
    }

    function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute('data-theme');
        const target = current === 'dark' ? 'light' : 'dark';
        if (target === 'dark') html.setAttribute('data-theme', 'dark');
        else html.removeAttribute('data-theme');
        localStorage.setItem('theme', target);
        updateThemeIcon(target);
    }

    function updateThemeIcon(theme) {
        const icon = document.querySelector('#themeBtn i');
        if (theme === 'dark') { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); } 
        else { icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); }
    }

    function fetchData() {
        Papa.parse(GOOGLE_SHEET_URL, {
            download: true, header: false,
            complete: function(results) {
                processData(results.data);
                document.getElementById('loader').style.display = 'none';
                document.getElementById('product-grid').style.display = 'grid';
            },
            error: function() { document.getElementById('loader').innerHTML = `<div class="error-msg">Error cargando precios.</div>`; }
        });
    }

    function roundToCustomRule(value) {
        if (!value) return 0;
        let integerVal = Math.round(value); 
        let remainder = integerVal % 100;
        return remainder <= 50 ? integerVal - remainder : integerVal + (100 - remainder);
    }

    function getImageForProduct(name) {
        const normalize = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        const lowerName = normalize(name);
        const customKeys = Object.keys(customImages).sort((a, b) => b.length - a.length);
        for (const key of customKeys) { if (lowerName.includes(key)) return customImages[key]; }
        for (const [brand, url] of Object.entries(brandImages)) { if (lowerName.includes(brand.toLowerCase())) return url; }
        return null;
    }

    function cleanProductName(name) {
        if (!name) return "";
        let clean = name.replace(/['"]/g, ''); 
        clean = clean.replace(/\b(perro|gato|perros|gatos)\b/gi, '').replace(/\s+/g, ' ').trim();
        return clean;
    }

    function processData(rows) {
        allProducts = [];
        // Funci√≥n auxiliar definida dentro para evitar errores de referencia
        const cleanPrice = (val) => {
            if (!val) return 0;
            let cleaned = val.toString().replace(/[$.]/g, '').replace(',', '.').replace(/[^\d.]/g, '');
            return roundToCustomRule(parseFloat(cleaned) || 0);
        };

        for (let i = 5; i < rows.length; i++) {
            const row = rows[i];
            let nombreRaw = row[2];
            if (!nombreRaw || nombreRaw.includes("DESCRIPCION")) continue;

            const weightRaw = row[3];
            const weight = (weightRaw && weightRaw.toString().trim() !== '') ? weightRaw : null;
            
            // --- LOGICA INTELIGENTE DE PRECIOS ---
            // 1. Obtenemos valores crudos de las columnas H (7) e I (8)
            let valColH = cleanPrice(row[7]);
            let valColI = cleanPrice(row[8]);
            
            let precioKg = 0;
            let precioBolsa = 0;

            const normalize = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            const lowerName = normalize(nombreRaw);
            
            let category = 'otros';
            let catLabel = ''; 
            
            // Detecci√≥n de Categor√≠a
            if (lowerName.match(/gato|cat|kitten|gati|whiskas|felino|7 vidas|fit 32|urinary/)) { category = 'gato'; catLabel = 'Gato'; }
            else if (lowerName.match(/perro|dog|cachorro|adulto|raza|pedigree|dogui|canino|advance|nutricare|old prince|sieger|pipon|gooster|junior|mini|medium|maxi|mordida|sileoni/)) { category = 'perro'; catLabel = 'Perro'; }
            
            // Detectamos si es un producto especial (Piedras, Sobres, etc)
            const isSpecial = lowerName.match(/piedra|arena|sanitaria|sobre|pouch|lata|humedo|golosina/);

            if (category === 'otros') {
                if (isSpecial) {
                    // CASO PIEDRAS/SOBRES: Forzamos que sea precio unitario (Bolsa) y anulamos el Kg
                    // Tomamos el valor mayor de cualquiera de las dos columnas
                    category = 'otros'; catLabel = ''; 
                    precioBolsa = Math.max(valColH, valColI);
                    precioKg = 0;
                } else {
                    // CASO ARROZ/CONEJIN (Granel en Otros): INVERTIMOS COLUMNAS
                    // El usuario tiene Bolsa en H y Kilo en I para estos productos
                    precioBolsa = valColH; // H es Bolsa
                    precioKg = valColI;    // I es Kg
                }
            } else {
                // CASO PERROS/GATOS (Est√°ndar): Mantenemos orden normal
                // H es Kg, I es Bolsa
                precioKg = valColH;
                precioBolsa = valColI;
            }

            let imgUrl = row[10] && row[10].startsWith('http') ? row[10] : getImageForProduct(nombreRaw);

            if (precioKg <= 0 && precioBolsa <= 0) continue;

            allProducts.push({
                nombre: cleanProductName(nombreRaw), 
                originalName: nombreRaw, 
                weight: weight, 
                imgUrl: imgUrl, 
                precioKg: precioKg > 0 ? precioKg : null, 
                precioBolsa: precioBolsa > 0 ? precioBolsa : null,
                category: category, 
                catLabel: catLabel, 
                isOffer: lowerName.includes('oferta') || lowerName.includes('promo')
            });
        }
        applyFilters();
    }

    function setCategory(cat, btn) {
        currentCategory = cat;
        document.querySelectorAll('.filter-btn').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed', 'false'); });
        if(btn) { btn.classList.add('active'); btn.setAttribute('aria-pressed', 'true'); }
        applyFilters();
    }

    function applyFilters() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const sortOrder = document.getElementById('priceSort').value;
        const grid = document.getElementById('product-grid');
        grid.innerHTML = '';
        const normalize = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        
        let filtered = allProducts.filter(p => {
            const matchCat = currentCategory === 'all' || p.category === currentCategory;
            const matchSearch = normalize(p.originalName).includes(normalize(term));
            return matchCat && matchSearch;
        });

        if (sortOrder !== 'default') {
            filtered.sort((a, b) => {
                const getMinPrice = (prod) => {
                    const prices = [];
                    if (prod.precioKg) prices.push(prod.precioKg);
                    if (prod.precioBolsa) prices.push(prod.precioBolsa);
                    return Math.min(...prices);
                };
                return sortOrder === 'asc' ? getMinPrice(a) - getMinPrice(b) : getMinPrice(b) - getMinPrice(a);
            });
        }

        if (filtered.length === 0) { grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-light);">No encontramos resultados üê∂üê±</div>'; return; }

        const fragment = document.createDocumentFragment();
        filtered.forEach(p => {
            const card = document.createElement('article'); card.className = 'card';
            let badgeHtml = p.isOffer ? `<div class="offer-badge">OFERTA</div>` : '';
            let catLabelHtml = p.catLabel ? `<span class="category-label horizontal">${p.catLabel}</span>` : '';
            
            // Icono por defecto
            let defaultIcon = 'fa-bag-shopping';
            if (p.category === 'perro') defaultIcon = 'fa-dog';
            if (p.category === 'gato') defaultIcon = 'fa-cat';

            let imgHtml = p.imgUrl ? 
                `<div class="card-img-container">${badgeHtml}<img src="${p.imgUrl}" alt="${p.nombre}" class="product-img" loading="lazy" width="200" height="200" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><i class="fa-solid fa-paw placeholder-icon" style="display:none"></i>${catLabelHtml}</div>` : 
                `<div class="card-img-container">${badgeHtml}<i class="fa-solid ${defaultIcon} placeholder-icon"></i>${catLabelHtml}</div>`;
            
            let pricesHtml = '';
            const fmt = n => n.toLocaleString('es-AR');
            const jsSafeName = p.nombre.replace(/'/g, "\\'");
            
            // Precio Suelto
            if (p.precioKg) {
                pricesHtml += `<div class="price-option"><div class="price-info"><span class="price-label">x Kg Suelto</span><span class="price-amount">$${fmt(p.precioKg)}</span></div><button class="btn-add" onclick="addToCart('${jsSafeName}', 'Kg', ${p.precioKg})"><i class="fa-solid fa-plus"></i></button></div>`;
            }
            
            // Precio Bolsa/Unidad
            if (p.precioBolsa) {
                let labelBolsa = 'Unidad';
                if (p.weight) {
                    const isNumber = !isNaN(parseFloat(p.weight)) && isFinite(p.weight);
                    // Si es categor√≠a 'otros' o texto (ej: Pack), usar texto directo
                    if (!isNumber || p.category === 'otros') {
                        labelBolsa = p.weight; 
                    } else {
                        labelBolsa = `Bolsa ${p.weight} Kg`;
                    }
                }

                pricesHtml += `<div class="price-option"><div class="price-info"><span class="price-label">${labelBolsa}</span><span class="price-amount">$${fmt(p.precioBolsa)}</span></div><button class="btn-add" onclick="addToCart('${jsSafeName}', '${labelBolsa}', ${p.precioBolsa})"><i class="fa-solid fa-plus"></i></button></div>`;
            }

            card.innerHTML = `${imgHtml}<div style="flex:1; display:flex; flex-direction:column;"><div class="card-header"><h2 class="card-title">${p.nombre}</h2></div><div class="card-body">${pricesHtml}</div></div>`;
            fragment.appendChild(card);
        });
        grid.appendChild(fragment);
    }

    function saveCart() { localStorage.setItem('peluditos_cart', JSON.stringify(cart)); }
    function loadCart() { const saved = localStorage.getItem('peluditos_cart'); if (saved) { cart = JSON.parse(saved); updateCartUI(); } }
    
    function addToCart(name, type, price) {
        const existing = cart.find(i => i.name === name && i.type === type);
        if (existing) existing.qty++; else cart.push({ name, type, price, qty: 1 });
        saveCart(); updateCartUI();
        const Toast = Swal.mixin({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500, background: 'var(--white)', color: 'var(--text)' });
        Toast.fire({ icon: 'success', title: 'Agregado' });
    }
    
    function changeQty(index, delta) { cart[index].qty += delta; if (cart[index].qty <= 0) cart.splice(index, 1); saveCart(); updateCartUI(); }
    
    function updateCartUI() {
        const container = document.getElementById('cart-items'); const totalEl = document.getElementById('cart-total'); const countEl = document.getElementById('cart-count');
        container.innerHTML = ''; let total = 0, count = 0;
        if(cart.length === 0) container.innerHTML = '<p style="text-align:center; color:var(--text-light); margin-top:50px;">Tu carrito est√° vac√≠o ü¶¥</p>';
        cart.forEach((item, index) => {
            total += item.price * item.qty; count += item.qty;
            container.innerHTML += `<div class="cart-item"><div style="flex-grow:1"><div style="font-weight:600; font-size:0.9rem; text-transform:capitalize;">${item.name.toLowerCase()}</div><div style="font-size:0.8rem; color:var(--text-light);">${item.type} x $${item.price.toLocaleString('es-AR')}</div></div><div class="qty-control"><button class="qty-btn" onclick="changeQty(${index}, -1)">-</button><span>${item.qty}</span><button class="qty-btn" onclick="changeQty(${index}, 1)">+</button></div></div>`;
        });
        totalEl.innerText = `$${total.toLocaleString('es-AR')}`; countEl.innerText = count; countEl.style.display = count > 0 ? 'flex' : 'none';
    }
    
    function toggleCart() { 
        closeAllModals(); 
        document.getElementById('cart-modal').classList.add('active'); 
        document.getElementById('cart-overlay').classList.add('active'); 
    }
    
    function closeAllModals() {
        document.querySelectorAll('.cart-modal').forEach(m => m.classList.remove('active'));
        document.getElementById('cart-overlay').classList.remove('active');
    }

    function checkout() {
        if (cart.length === 0) return Swal.fire({ title: 'Ups', text: 'El carrito est√° vac√≠o', icon: 'warning', background: 'var(--white)', color: 'var(--text)' });
        closeAllModals();
        
        const deliveryOpt = document.getElementById('opt-delivery');
        const deliveryText = document.getElementById('delivery-text');
        
        if (!ENABLE_DELIVERY) { deliveryOpt.disabled = true; deliveryText.innerText = "(No disponible)"; } 
        else { deliveryOpt.disabled = false; deliveryText.innerText = "Env√≠o a domicilio"; }

        // AUTO-FILL si est√° logueado
        if (currentUser) {
            document.getElementById('cx-name').value = currentUser.name;
            document.getElementById('cx-phone').value = currentUser.phone;
        }

        document.getElementById('checkout-modal').classList.add('active');
        document.getElementById('cart-overlay').classList.add('active'); 
    }

    function closeCheckout() {
        document.getElementById('checkout-modal').classList.remove('active');
        document.getElementById('cart-modal').classList.add('active');
    }

    function toggleAddress(show) {
        const section = document.getElementById('address-section');
        if (show) section.classList.remove('hidden'); else section.classList.add('hidden');
    }

    function sendOrder() {
        const name = document.getElementById('cx-name').value;
        const phone = document.getElementById('cx-phone').value;
        if (!name || !phone) return Swal.fire({ title: 'Faltan datos', text: 'Por favor completa nombre y tel√©fono', icon: 'error' });

        const deliveryType = document.querySelector('input[name="deliveryType"]:checked').value;
        const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
        const obs = document.getElementById('cx-obs').value;

        let addressText = "";
        if (deliveryType === 'delivery') {
            const calle = document.getElementById('cx-calle').value;
            const extra = document.getElementById('cx-piso').value;
            const entre = document.getElementById('cx-entre').value;
            if (!calle) return Swal.fire({ text: 'Por favor indica la direcci√≥n de entrega', icon: 'warning' });
            addressText = `üìç *Env√≠o a:* ${calle} ${extra ? '('+extra+')' : ''}\n`;
            if(entre) addressText += `   Entre: ${entre}\n`;
        } else {
            addressText = `üè™ *Retiro en Local*\n`;
        }

        let msg = `Hola Peluditos! üëã Soy *${name}*.\n`;
        msg += `üìû Tel: ${phone}\n\n`;
        msg += `üìã *MI PEDIDO:*\n`;
        
        let total = 0;
        cart.forEach(i => { let sub = i.price * i.qty; total += sub; msg += `‚ñ™Ô∏è ${i.qty} x ${i.name} (${i.type}) = $${sub.toLocaleString('es-AR')}\n`; });
        
        msg += `\nüí∞ *TOTAL: $${total.toLocaleString('es-AR')}*\n`;
        msg += `------------------\n`;
        msg += addressText;
        msg += `üí≥ *Pago:* ${paymentType.toUpperCase()}\n`;
        if(obs) msg += `üìù *Nota:* ${obs}\n`;

        if (!currentUser) {
             // Podr√≠amos guardar usuario temporal aqu√≠
        }
        
        const orderRecord = { date: new Date().toISOString(), items: [...cart], total: total };
        let historyKey = 'peluditos_history_' + phone.replace(/\D/g,'');
        let currentHistory = JSON.parse(localStorage.getItem(historyKey)) || [];
        currentHistory.push(orderRecord);
        localStorage.setItem(historyKey, JSON.stringify(currentHistory));
        
        if (currentUser && currentUser.phone === phone) {
            userHistory = currentHistory;
        }

        window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
    }
</script>

</body>
</html>